image: registry.gitlab.com/squeylab/container-images/send_to_squey:8aa4b347

stages:
- publish
- pages

publish testpypi:
  stage: publish
  variables:
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $TESTPYPI_PASSWORD
  script: |
    python -m build
    python -m twine upload --repository testpypi dist/*
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "false" && $CI_COMMIT_TAG =~ /^version-\d+\.\d+\.\d+$/'
  interruptible: true

publish pypi:
  stage: publish
  variables:
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $PYPI_PASSWORD
  script: |
    python -m build
    python -m twine upload --repository pypi dist/*
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"  && $CI_COMMIT_TAG =~ /^version-\d+\.\d+\.\d+$/'

pages:
  stage: pages
  before_script: |
    mkdir public
  script: |
    cd doc
    sphinx-build -W -j auto -b html . ../public
  after_script: |
    cp CHANGELOG public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"  && $CI_COMMIT_TAG =~ /^version-\d+\.\d+\.\d+$/'
  interruptible: true

